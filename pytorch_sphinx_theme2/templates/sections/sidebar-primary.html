{# Override of sidebar-primary.html to hide Section Navigation when empty #}
{# Uses generate_toctree_html() to check actual rendered content instead of toctree existence #}
{# This correctly handles :hidden: toctrees - they won't produce output #}

{% block docs_sidebar %}
{# Generate the actual toctree HTML to check if there's real content to display #}
{% set toctree_html = generate_toctree_html(
    "sidebar",
    startdepth=1,
    show_nav_level=theme_show_nav_level|int if theme_show_nav_level else 1,
    maxdepth=theme_navigation_depth|int if theme_navigation_depth else 4,
    collapse=theme_collapse_navigation|tobool if theme_collapse_navigation else false,
    includehidden=theme_sidebar_includehidden|tobool if theme_sidebar_includehidden else true,
    titles_only=true
) %}

{# Check if the rendered toctree content is actually empty #}
{% set has_sidebar_content = toctree_html|trim|length > 0 %}

{# Determine if we should show the sidebar at all #}
{# Show if: there's actual toctree content, OR we have mobile nav items to display #}
{% set show_sidebar = has_sidebar_content or theme_navbar_center or theme_navbar_end or theme_primary_sidebar_end %}

{% if show_sidebar %}
  {# Header items that will be displayed in the sidebar on mobile #}
  <div class="sidebar-header-items sidebar-primary__section">
    {# The header center items #}
    {% if theme_navbar_center %}
      <div class="sidebar-header-items__center">
        {% for navbar_item in theme_navbar_center %}
          {# In the mobile sidebar we do not want a dropdown, so set a large cutoff (999). #}
          {% with theme_header_links_before_dropdown=999 %}
            <div class="navbar-item">{% include navbar_item %}</div>
          {% endwith %}
        {% endfor %}
      </div>
    {% endif %}
    {# The header end items #}
    {% if theme_navbar_end %}
      <div class="sidebar-header-items__end">
        {% for navbar_item in theme_navbar_end %}
          <div class="navbar-item">{% include navbar_item %}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  {# Only render Section Navigation if there's actual toctree content #}
  {% if sidebars and has_sidebar_content %}
    <div class="sidebar-primary-items__start sidebar-primary__section">
      {%- for sidebartemplate in sidebars %}
        <div class="sidebar-primary-item">{%- include sidebartemplate %}</div>
      {%- endfor %}
    </div>
  {% endif %}

  {# Items that will snap to the bottom of the screen #}
  <div class="sidebar-primary-items__end sidebar-primary__section">
    {%- for sidebartemplate in theme_primary_sidebar_end %}
      <div class="sidebar-primary-item">{%- include sidebartemplate %}</div>
    {%- endfor %}
  </div>
  {# add the rtd flyout in the sidebar if existing #}
  <div id="rtd-footer-container"></div>
{% endif %}
{% endblock docs_sidebar %}
